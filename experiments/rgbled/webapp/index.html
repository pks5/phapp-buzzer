<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">

    <title>RGB LED - Raspilab Experiments</title>

    <style>
      #color{
        width:128px;
        height:128px;
        margin:1rem auto;
      }
        .color-button{
          width:24px;
          height:24px;
        }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Raspilab Experiments</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="#">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Features</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Pricing</a>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    
    <div class="container">
      <h1>RGB LED</h1>

      <select class="form-select" id="deviceSelect">
        <option selected>Select Device</option>
      </select>

      <div id="color">

      </div>

      <div class="buttons">
        <button class="color-button" data-color="red"></button>
        <button class="color-button" data-color="green"></button>
        <button class="color-button" data-color="blue"></button>
        <button class="color-button" data-color="yellow"></button>
        <button class="color-button" data-color="magenta"></button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@6.1.0/bundles/stomp.umd.min.js"></script>

    <script>
        let sTargetAppId = "net.featurehub.phapp.sys";
        let sTargetScriptName = "rgbled.py";
        let sSourceAppId = "net.raspilab.webapp.rgbled";
        let oFeatureHub;

        let fnConnect = function(){
            oFeatureHub = new FeatureHub({
                clientId: 'phapp_buzzer', 
                redirectUri: location.origin + location.pathname
            });

            oFeatureHub.getClient().addEventListener("connect", function(){
                oFeatureHub.devices(onReceiveDevices);
            });

            oFeatureHub.connect();
        };

        let scriptLocation = 'https://my.featurehub.net/lib/v1/fhub.js';

        if(location.hostname.indexOf('.localnet') !== -1){
            scriptLocation = 'http://my.featurehub.localnet:8787/lib/v1/fhub.js';
        }

        const script = document.createElement('script');
        script.src = scriptLocation;
        script.addEventListener('load', fnConnect);
        document.body.appendChild(script);

        let aColorFields = document.querySelectorAll(".color-button");
        for(let i=0; i < aColorFields.length; i++){
          aColorFields[i].style.backgroundColor = aColorFields[i].dataset.color;
          aColorFields[i].addEventListener("click", function(){
            let sFrom = "fhtp://webapp/" + sSourceAppId,
                sTo = "fhtp://device/" + elSelect.value + "/sendMessage?app=" + sTargetAppId + "&script=" + sTargetScriptName;
            oFeatureHub.sendToScript(sFrom, sTo, { "mode":"ON", color:this.dataset.color });
          });
        }
        
        let elSelect = document.getElementById("deviceSelect");
        
        let onReceiveDevices = function(oData){  
          for (let i = 0; i<oData.devices.length; i++){
            let oDevice = oData.devices[i], 
                elOpt = document.createElement('option');
            elOpt.value = oDevice.machineId;
            elOpt.innerHTML = oDevice.hostName + " (" + oDevice.lastComConnectDate + ")";
            elSelect.appendChild(elOpt);
          }
        };

        

        let onReceiveData = function(oData, mHeaders){
            let to = new URL(mHeaders["fh-from"]),
                sPhappId = to.searchParams.get("app");

            if(sPhappId === "net.featurehub.phapp.sys"){
                console.log('S', oData, mHeaders);
                
                let sMode = oData.status.mode;
                if(sMode === "ON"){
                  document.getElementById("color").style.backgroundColor = oData.status.color;
                }
                else if(sMode  === "OFF"){
                  document.getElementById("color").style.backgroundColor = "transparent";
                }
            }
        };

        elSelect.addEventListener("change", function(){
          if(elSelect.value){
            oFeatureHub.unsubscribe('deviceStatus');
            oFeatureHub.subscribeToDevice('deviceStatus', elSelect.value, onReceiveData);

            let sFrom = "fhtp://webapp/" + sSourceAppId,
                sTo = "fhtp://device/" + elSelect.value + "/sendMessage?app=" + encodeURIComponent(sTargetAppId) + "&script=" + encodeURIComponent(sTargetScriptName);
            oFeatureHub.sendToScript(sFrom, sTo, { "action":"STATUS" });
          }
        });

        
    
        document.getElementById("testBtn").addEventListener("click", function(){
            
        });

        
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
    
    
  </body>
</html>
